<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Bus Count</title>

    <script type="text/javascript">

        function jsonifyForm(node, json={}) {
            node = node.firstChild;
            while (node) {
                if (node.name) {
                    if (node.value) {
                        if (isNaN(node.value)) {
                            json[node.name] = node.value;
                        } else {
                            json[node.name] = parseFloat(node.value);
                        }
                    } else {
                        json[node.name] = jsonifyForm(node);
                    }
                } else {
                    jsonifyForm(node, json);
                }
                node = node.nextSibling;
            }
            return json;
        }

        function submitForm(form, url){
            let data = jsonifyForm(form);

            let xhr = new XMLHttpRequest();
            xhr.open(form.method, url, true);
            xhr.setRequestHeader("Content-Type", "application/json");
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        console.log("Sent '" + url + "'")
                        alert("Done")
                    } else {
                        alert("Failed: (" + status + ")")
                    }
                } else {
                    console.log(xhr.readyState + " " + xhr.status);
                    console.debug(xhr);
                }
            };

            console.log('Sending to ' + url + "':");
            console.log(data);
            xhr.send(JSON.stringify(data));
            //xhr.send('{"delta": "5"}');
        }
    </script>

    <style>
        input {
            display: block;
        }
        label::after {
            content: ':';
        }
    </style>

</head>
<body>

<h1>Bus Count Control</h1>

<h2>Get requests</h2>
<ul>
    <li><a href="devices">devices</a></li>
    <li><a href="get_config">get_config</a></li>
    <li><a href="count">count</a></li>
</ul>

<h2>Post requests</h2>
<h3>Register</h3>
<form method="post" action="javascript:void(0);" onsubmit="submitForm(this, 'register')">
    <label for="reg_name">Name</label> <input type="text" name="name" id="reg_name"/>
    <label for="reg_id">ID</label> <input type="text" name="id" id="reg_id"/>
    <fieldset name="default_feed">
        <legend>Default Feed</legend>
        <label for="def_name">Name</label> <input type="text" name="name" id="def_name"/>
        <label for="def_loc">Location</label> <input type="text" name="location" id="def_loc"/>
    </fieldset>

    <input type="submit" value="Register">
</form>

<h3>Set Config</h3>
<form method="post" action="javascript:void(0);" onsubmit="submitForm(this, 'set_config')">
    <fieldset name="line_in">
        <legend>In Line</legend>
        <label for="in_x1">x1</label> <input type="number" name="x1" id="in_x1" step="0.1" min="0" max="1"/>
        <label for="in_y1">y1</label> <input type="number" name="y1" id="in_y1" step="0.1" min="0" max="1"/>
        <label for="in_x2">x2</label> <input type="number" name="x2" id="in_x2" step="0.1" min="0" max="1"/>
        <label for="in_y2">y2</label> <input type="number" name="y2" id="in_y2" step="0.1" min="0" max="1"/>
    </fieldset>

    <fieldset name="line_out">
        <legend>Out Line</legend>
        <label for="out_x1">x1</label> <input type="number" name="x1" id="out_x1" step="0.1" min="0" max="1"/>
        <label for="out_y1">y1</label> <input type="number" name="y1" id="out_y1" step="0.1" min="0" max="1"/>
        <label for="out_x2">x2</label> <input type="number" name="x2" id="out_x2" step="0.1" min="0" max="1"/>
        <label for="out_y2">y2</label> <input type="number" name="y2" id="out_y2" step="0.1" min="0" max="1"/>
    </fieldset>

    <input type="submit" value="Set Config">
</form>

<h3>Status Update</h3>
<p>NOTE: this works, but the data format is wrong!!!!</p>
<form method="post" action="javascript:void(0);" onsubmit="submitForm(this, 'status_update')">
    <label for="change">Delta people</label><input type="number" name="delta" id="change"/>

    <input type="submit" value="Update">
</form>


</body>
</html>